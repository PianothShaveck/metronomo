const e={it:{start:"Avvia metronomo",stop:"Ferma metronomo",tempo:"Tempo (BPM)",speed:"Velocità:",extra_functions:"Funzioni Extra",tap_tempo:"Tap Tempo",visual_flash:"Flash Visivo",accent:"Accento",enable_accent:"Attiva accento",every:"Ogni",beats:"battiti",gradual_scale:"Scalata metronomica",initial_speed:"Velocità iniziale",final_speed:"Velocità finale",increment:"Incremento",num_beats:"Numero di battiti",time_remaining:"Tempo rimanente: ~{0} minuti"},en:{start:"Start Metronome",stop:"Stop Metronome",tempo:"Tempo (BPM)",speed:"Speed:",extra_functions:"Extra Functions",tap_tempo:"Tap Tempo",visual_flash:"Visual Flash",accent:"Accent",enable_accent:"Enable accent",every:"Every",beats:"beats",gradual_scale:"Gradual Speed Increase",initial_speed:"Initial speed",final_speed:"Final speed",increment:"Increment",num_beats:"Number of beats",time_remaining:"Time remaining: ~{0} minutes"},zh:{start:"启动节拍器",stop:"停止节拍器",tempo:"速度 (BPM)",speed:"速度：",extra_functions:"额外功能",tap_tempo:"敲击节奏",visual_flash:"视觉闪烁",accent:"重音",enable_accent:"启用重音",every:"每",beats:"拍",gradual_scale:"逐渐加速",initial_speed:"初始速度",final_speed:"最终速度",increment:"增量",num_beats:"拍数",time_remaining:"剩余时间：约{0}分钟"}};function t(){const t=localStorage.getItem("language");if(t&&e[t])return t;const n=navigator.language||navigator.userLanguage;return n.toLowerCase().includes("zh")?"zh":n.toLowerCase().includes("it")?"it":"en"}function n(t){const n=e[t]||e.en;document.querySelectorAll("[data-i18n]").forEach(e=>{const t=e.getAttribute("data-i18n");n[t]&&(e.textContent=n[t])}),localStorage.setItem("language",t)}document.addEventListener("DOMContentLoaded",()=>{n(t())}),(()=>{let t,n,a,o=null;const l=new XMLHttpRequest;let c=!1,i=120,r=0,u=!1,m=4,s=[],p=!1;function v(){const e=t.createBufferSource();if(e.buffer=o,u&&r%m===0&&(e.detune.value=1200),e.connect(t.destination),e.start(0),c=!0,p){const e=document.getElementById("flash-overlay");e.classList.add("flash"),setTimeout(()=>{e.classList.remove("flash")},150)}}function g(){if(document.querySelector("#animation-start-btn").disabled=!0,document.querySelector("#animation-stop-btn").disabled=!1,document.querySelector("#bar-animation").beginElement(),c=!0,v(),clearInterval(n),n=setInterval(()=>{c&&(r++,v())},clickSpeed),document.querySelector("#gradual-increment").checked){const{startBpm:e,endBpm:t,incrementValue:o,incrementClicks:l}=I();if(e>t)return alert("La velocità iniziale deve essere più lenta di quella finale."),document.querySelector("#start-bpm").value=t,void b();document.querySelector("#bpm-slider").value=e,f(),y();let i=Math.round(.5+(t-e)/o),u=Date.now()+l*q(e,i,o)*6e4;clearInterval(a),a=setInterval(()=>{d=Date.now(),S((u-d)/6e4)});let m=e,s=0;clearInterval(n),n=setInterval(()=>{c?(r++,v(),s++,s===l&&(s=0,m=Math.min(t,m+o),document.querySelector("#bpm-slider").value=m,document.querySelector("#start-bpm").value=m,f(),y())):setTimeout(b,6)},clickSpeed)}}function b(){document.querySelector("#animation-start-btn").disabled=!1,document.querySelector("#animation-stop-btn").disabled=!0,document.querySelector("#bar-animation").endElement(),clearInterval(n),clearInterval(a),c=!1,r=0}function y(){i=document.querySelector("#bpm-slider").value,animationSpeed=60/i*2,clickSpeed=animationSpeed/2*1e3;const e=document.querySelector("#bar-animation");if(e.setAttribute("dur",animationSpeed+"s"),e.beginElement(),document.querySelector("#gradual-increment").checked){document.querySelector("#start-bpm").value=i;const{startBpm:e,endBpm:t,incrementValue:o,incrementClicks:l}=I();if(e>t)return alert("La velocità iniziale deve essere più lenta di quella finale."),document.querySelector("#start-bpm").value=t,void b();document.querySelector("#bpm-slider").value=e;let u=Math.round(.5+(t-e)/o),m=Date.now()+l*q(e,u,o)*6e4,s=e,p=0;clearInterval(n),clearInterval(a),a=setInterval(()=>{d=Date.now(),S((m-d)/6e4)}),n=setInterval(()=>{c?(r++,v(),p++,p===l&&(p=0,s=Math.min(t,s+o),document.querySelector("#bpm-slider").value=s,document.querySelector("#start-bpm").value=s,f(),y())):setTimeout(b,6)},clickSpeed)}else c?(clearInterval(n),n=setInterval(()=>{r++,v()},clickSpeed)):setTimeout(b,6)}function f(){var e=document.querySelector("#bpm-slider").value;document.querySelector("#slider-value").value=e}function S(t){const n=localStorage.getItem("language")||"it",a=(e[n]||e.it).time_remaining.replace("{0}",t.toFixed(2));document.getElementById("time").innerHTML=a}function h(){var e=document.querySelector("#slider-value").value;document.querySelector("#bpm-slider").value=e,y()}function E(){const e=document.querySelector("#gradual-inputs");document.querySelector("#gradual-increment").checked?(e.style.display="block",e.scrollIntoView({behavior:"smooth"})):e.style.display="none"}function I(){return{startBpm:+document.querySelector("#start-bpm").value,endBpm:+document.querySelector("#end-bpm").value,incrementValue:+document.querySelector("#increment-value").value,incrementClicks:+document.querySelector("#increment-clicks").value}}function q(e,t,n){return Math.log((e+n*t)/(e-n))/n-n*(t+1)/(2*(e-n)*(e+n*t))}function B(){const e=document.getElementById("accent-settings");u=document.getElementById("accent-enabled").checked,e.style.display=u?"flex":"none"}function _(){m=parseInt(document.getElementById("accent-interval").value)}function L(){const e=Date.now();if(s.length>0&&e-s[s.length-1]>2e3&&(s=[]),s.push(e),s.length>1){let e=[];for(let t=1;t<s.length;t++)e.push(s[t]-s[t-1]);e.length>4&&(e=e.slice(e.length-4));const t=e.reduce((e,t)=>e+t,0)/e.length,n=Math.round(6e4/t);n>=20&&n<=300&&(document.getElementById("bpm-slider").value=n,f(),y())}}function k(){p=document.getElementById("visual-flash").checked}function w(){const e=document.documentElement,t="dark"===e.getAttribute("data-theme")?"light":"dark";e.setAttribute("data-theme",t),localStorage.setItem("theme",t)}l.open("GET","m.mp3",!0),l.responseType="arraybuffer",l.onload=function(){t.decodeAudioData(l.response,function(e){o=e})},window.addEventListener("load",()=>{t=new AudioContext,l.send(),document.querySelector("#animation-stop-btn").disabled=!0,y()}),document.addEventListener("DOMContentLoaded",()=>{!function(){const e=localStorage.getItem("theme");e&&document.documentElement.setAttribute("data-theme",e)}(),t=new(window.AudioContext||window.webkitAudioContext),l.send(),document.getElementById("animation-start-btn").addEventListener("click",g),document.getElementById("animation-stop-btn").addEventListener("click",b),document.getElementById("bpm-slider").addEventListener("input",f),document.getElementById("bpm-slider").addEventListener("change",y),document.getElementById("slider-value").addEventListener("change",h),document.getElementById("gradual-increment").addEventListener("change",E),document.getElementById("accent-enabled").addEventListener("change",B),document.getElementById("accent-interval").addEventListener("change",_),document.getElementById("tap-tempo-btn").addEventListener("click",L),document.getElementById("visual-flash").addEventListener("change",k),document.getElementById("theme-toggle").addEventListener("click",w),document.getElementById("animation-stop-btn").disabled=!0,y()})})();